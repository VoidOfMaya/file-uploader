<section id="file-info">

        <h1>welcome <%= user.firstName %></h1> 
    
    <section class="storage-creation" style="height: 100%; display: flex;flex-direction: row; gap: 5px;""> 

        <button style="flex: 1;" type="button"  id="add-file-global">upload new file</button>
        <button style="flex: 1;" id="show-folder-creation-dialog" type="button">create Folder</button>

    </section>
</section>

<section class="storage-container">
    <% if(folders.length === 0 && files.length === 0){ %>
        <div style="width: fit-content; align-self: center; font-size: 22px; color: rgb(90, 89, 89);">your storage is empty!</div>
    <% } %>
    <% if(folders.length > 0 ){ %>   
        <% folders.forEach(folder => { %>
            <div class="folder-Btn storage-Btn">
                <img src="/icons/folder-solid-full.svg" alt="folder" width="50" height="50">
                <div style="white-space: nowarp; text-overflow: ellipsis;  overflow: hidden;" ><%= folder.name %> </div>
                <span>Folder</span>
                <span>---</span>
                <form method="get" action="/folders/<%= folder.id %>">
                    <button style="width: 100%; height: 100%;">view</button>                    
                </form> 
                <button id="delete-folder-btn" type="button" name="deleteFolderId" value="<%- folder.id %>">delete</button>
            
                <script>
                const deleteFolder = document.getElementById('delete-folder-btn');

                deleteFolder.addEventListener('click',async ()=>{
                    let confirmation = confirm(`you are about to delete folder at id: ${deleteFolder.value},on this action all related files will be realocated to the home page,do you wish to continue?`)
                    if(confirmation){
                        console.log(`preform delete...`)
                        const res = await fetch(`/folders/delete`,{
                                    method: "POST",
                                    headers: { "content-Type": "application/json"},
                                    body: JSON.stringify({folderId: deleteFolder.value})
                                })
                        if(res.ok){
                            window.location.href = '/';
                        }

                    }
                })
                </script> 
            </div> 
        
        <% })%>
    <% } %>
    <%if(files.length > 0 ){%> 
        <% files.forEach(file => { %>
                <div class="file-Btn storage-Btn">
                    <img src="/icons/file-solid-full.svg" alt="folder" width="50" height="50">
                    <div style="white-space: nowarp; text-overflow: ellipsis; overflow: hidden;"><%= file.originalName %></div> 
                    <div><%= file.mimeType %> </div>
                    <div><%= Math.round((file.size/ 1024)* 100)/100 %>Kb </div>
                    <div> <%= new Date(file.uploadTime).toLocaleTimeString() %> 
                        <%= new Date(file.uploadTime).toLocaleDateString() %></div>
                    
                    <a href="/upload/download/<%= file.id%>" download="<%= file.originalName%>">download</a> 
        
                </div>            
        <% }) %>
    <% } %>        
</section>

<dialog id="create-folder-dialog">
    <p style="font-size: 12px; color: red;">Folder name may only contain letters, numbers, hyphens (-),spaces, and underscores (_)</p>
    <form method="post" action="/folders/new" id="folder-dialog-form">
        <label for="folderName">Folder name: </label>
        <input name="folderName" type="text" min="1" max="20" required/>
        <button id="create-folder-btn">Create</button> 
        <button type="button" id="cancel-folder-dialog">cancel</button>         
    </form>


</dialog>

<dialog id="create-file-dialog">
    <p style="font-size: 12px; color: red;">file type must be( .png/ .jpeg/ .webp/ .pdf/ .msword/ )</p>
    <form action="/upload/file" method="post" enctype="multipart/form-data" id="dialog-file-creation-form">
        <input type="file" id="upFile" name="upFile"/>
        <label for="upFile"></label>
        <button id="upload-file-btn">Upload</button>
        <button type="button" id="cancel-add-file-dialog">cancel</button>
    </form>
</dialog>

<script>
    //folder create dialog
    const openDialog = document.getElementById('show-folder-creation-dialog');
    const dialog = document.getElementById('create-folder-dialog');
    const submitFolderForm = document.getElementById('folder-dialog-form');
    const cancelBtn = document.getElementById('cancel-folder-dialog');
    openDialog.addEventListener('click',()=>{
        dialog.showModal();
    })
    submitFolderForm.addEventListener('submit',()=>{
        dialog.close();
    })
    cancelBtn.addEventListener('click',()=>{
        dialog.close();
    })
    //file create dialog
    const openFiledialogBtn = document.getElementById('add-file-global');
    const fileDialog = document.getElementById('create-file-dialog');
    const cancelFileDialog= document.getElementById('cancel-add-file-dialog')
    openFiledialogBtn.addEventListener('click',()=>{
        fileDialog.showModal();
    })
    cancelFileDialog.addEventListener('click',()=>{
        fileDialog.close();
    })
    //hanndle file upload validation
    const input = document.getElementById('upFile');
    const form = document.getElementById('dialog-file-creation-form');
    const submitFileBtn = document.getElementById('upload-file-btn');

    form.addEventListener('submit',(e)=>{
        if( !input.files|| input.files.length === 0){
            e.preventDefault();
            alert("please select a file");
        }
    })



</script>